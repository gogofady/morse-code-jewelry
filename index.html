<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <title>Morse Jewelry | Express Yourself in Secret</title>
  <meta property="og:title" content="Morse Jewelry - Personalized Secret Messages" />
  <meta property="og:description" content="Convert any name or word into beautiful handmade jewelry using Morse code." />
  
  <meta property="og:image" content="./morse_code.png" />
  
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="icon" href="./morse_code.png" type="image/png">

  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .hidden-until-ready { opacity: 0; transition: opacity .25s ease-in; }
    .visible-ready { opacity: 1; }
    
    /* Animations */
    .flash-slide-in { animation: slideIn 0.5s ease-out forwards; }
    @keyframes slideIn { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }
    
    .modal-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    /* Arabic Font */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
    .font-arabic { font-family: 'Cairo', sans-serif; }
  </style>
</head>
<body class="bg-gray-50 transition-all duration-300">

<div id="root" class="hidden-until-ready"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// ---------- Firebase config ----------
const firebaseConfig = {
  apiKey: "AIzaSyDHRFiiklg8k8gmt1QGEstSM5hfTJvIZW8",
  authDomain: "morse-code-jewelry.firebaseapp.com",
  projectId: "morse-code-jewelry",
  storageBucket: "morse-code-jewelry.firebasestorage.app",
  messagingSenderId: "1034331508828",
  appId: "1:1034331508828:web:08acf02e2363000e99d699",
  measurementId: "G-C4WH6X1N1Z"
};

const app = initializeApp(firebaseConfig);
try { getAnalytics(app); } catch(e) { console.info("Analytics init skipped:", e?.message || e); }

const auth = getAuth(app);
const db = getFirestore(app);

// Your Google Sheet
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxuMlTdvd8sJYjNni9vvFEXsgtk8nLjCNqpbDYyjGmMnBX22EK7l3DT86vGnCtCtQyF/exec";

// Morse Dictionary
const MORSE_CODE = { 
  'a': '.-', 'b': '-...', 'c': '-.-.', 'd': '-..', 'e': '.', 'f': '..-.', 'g': '--.', 'h': '....', 'i': '..', 'j': '.---', 'k': '-.-', 'l': '.-..', 'm': '--', 'n': '-.', 'o': '---', 'p': '.--.', 'q': '--.-', 'r': '.-.', 's': '...', 't': '-', 'u': '..-', 'v': '...-', 'w': '.--', 'x': '-..-', 'y': '-.--', 'z': '--..', '1': '.----', '2': '..---', '3': '...--', '4': '....-', '5': '.....', '6': '-....', '7': '--...', '8': '---..', '9': '----.', '0': '-----', ' ': ' / ' 
};

// Translations
const translations = {
  en: {
    title: "Morse Jewelry",
    shop: "Shop",
    gallery: "Gallery",
    contact: "Contact",
    search_placeholder: "Search items...",
    cart_empty: "Your cart is empty",
    shop_now: "Shop Now",
    hero_title: "Express Yourself in Secret",
    hero_sub: "Beautiful jewelry with a hidden meaning.",
    collection: "Our Collection",
    add_cart: "Add to Cart",
    customize: "Customize", 
    original_price: "EGP", 
    morse_title: "What is Morse Code?",
    morse_desc_1: "Morse code encodes text characters as sequences of dots (.) and dashes (-).",
    morse_desc_2: "We use Round Beads for Dots and Long Beads for Dashes.",
    morse_secret: "It's a secret message only you understand!",
    spotlight: "Customer Spotlight Gallery",
    spotlight_sub: "Click on any photo to shop the look!",
    your_cart: "Your Shopping Cart",
    subtotal: "Subtotal",
    shipping: "Shipping Fees",
    shipping_banner: "üöö Free shipping on orders over 1000 EGP!",
    free: "FREE", 
    total: "Total",
    clear_cart: "Clear Cart",
    proceed: "Proceed to Checkout",
    checkout_title: "Checkout",
    full_name: "Full Name",
    phone_1: "Phone Number (11 digits)",
    phone_2: "Backup Phone (Optional)",
    address: "Shipping Address",
    custom_title: "Personalize Your Secret Message",
    custom_hint: "Type your name to see the Morse preview:",
    custom_limit: "(Up to 10 characters)",
    place_order: "Place Order",
    contact_us: "Contact Us",
    send_msg: "Send Message",
    footer_rights: "All rights reserved.",
    back_shop: "Back to Shop",
    you_like: "You might also like",
    added_cart: "Added to cart successfully",
    order_success_title: "Order Successful! üéâ",
    order_success_msg: "Thank you for your order. We have received it and will contact you shortly to confirm details.",
    close: "Close",
    fill_fields: "Please fill all required fields",
    phone_error: "Phone number must be exactly 11 digits",
    secure_checkout: "Secure Checkout",
    easy_returns: "Easy Returns",
    customer_support: "Customer Support"
  },
  ar: {
    title: "ŸÖŸàÿ±ÿ≥ ŸÑŸÑŸÖÿ¨ŸàŸáÿ±ÿßÿ™",
    shop: "ÿßŸÑŸÖÿ™ÿ¨ÿ±",
    gallery: "ÿßŸÑŸÖÿπÿ±ÿ∂",
    contact: "ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÜÿß",
    search_placeholder: "ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨...",
    cart_empty: "ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ ŸÅÿßÿ±ÿ∫ÿ©",
    shop_now: "ÿ™ÿ≥ŸàŸÇ ÿßŸÑÿ¢ŸÜ",
    hero_title: "ÿπÿ®ÿ± ÿπŸÜ ŸÜŸÅÿ≥ŸÉ ÿ®ÿ≥ÿ±Ÿäÿ©",
    hero_sub: "ŸÖÿ¨ŸàŸáÿ±ÿßÿ™ ÿ¨ŸÖŸäŸÑÿ© ÿ™ÿ≠ŸÖŸÑ ŸÖÿπŸÜŸâ ÿÆŸÅŸä",
    collection: "ŸÖÿ¨ŸÖŸàÿπÿ™ŸÜÿß ÿßŸÑŸÖŸÖŸäÿ≤ÿ©",
    add_cart: "ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©",
    customize: "ÿ™ÿÆÿµŸäÿµ", 
    original_price: "ÿ¨.ŸÖ",
    morse_title: "ŸÖÿß ŸáŸä ÿ¥ŸÅÿ±ÿ© ŸÖŸàÿ±ÿ≥ÿü",
    morse_desc_1: "ÿ¥ŸÅÿ±ÿ© ŸÖŸàÿ±ÿ≥ ÿ™ÿ≠ŸàŸÑ ÿßŸÑÿ≠ÿ±ŸàŸÅ ÿ•ŸÑŸâ ŸÜŸÇÿßÿ∑ (.) Ÿàÿ¥ÿ±ÿ∑ÿßÿ™ (-).",
    morse_desc_2: "ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿÆÿ±ÿ≤ ÿßŸÑÿØÿßÿ¶ÿ±Ÿä ŸÑŸÑŸÜŸÇÿßÿ∑ ŸàÿßŸÑÿÆÿ±ÿ≤ ÿßŸÑÿ∑ŸàŸäŸÑ ŸÑŸÑÿ¥ÿ±ÿ∑ÿßÿ™.",
    morse_secret: "ÿ•ŸÜŸáÿß ÿ±ÿ≥ÿßŸÑÿ© ÿ≥ÿ±Ÿäÿ© ŸÑÿß ŸäŸÅŸáŸÖŸáÿß ÿ•ŸÑÿß ÿ£ŸÜÿ™!",
    spotlight: "ŸÖÿπÿ±ÿ∂ ÿµŸàÿ± ÿßŸÑÿπŸÖŸÑÿßÿ°",
    spotlight_sub: "ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ÿµŸàÿ±ÿ© ŸÑÿ¥ÿ±ÿßÿ° ŸÜŸÅÿ≥ ÿßŸÑŸÖŸÜÿ™ÿ¨!",
    your_cart: "ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÉ",
    subtotal: "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä",
    shipping: "ŸÖÿµÿßÿ±ŸäŸÅ ÿßŸÑÿ¥ÿ≠ŸÜ",
    shipping_banner: "üöö ÿ¥ÿ≠ŸÜ ŸÖÿ¨ÿßŸÜŸä ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÅŸàŸÇ Ÿ°Ÿ†Ÿ†Ÿ† ÿ¨.ŸÖ!",
    free: "ŸÖÿ¨ÿßŸÜŸä", 
    total: "ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä",
    clear_cart: "ÿ•ŸÅÿ±ÿßÿ∫ ÿßŸÑÿ≥ŸÑÿ©",
    proceed: "ÿ•ÿ™ŸÖÿßŸÖ ÿßŸÑÿ¥ÿ±ÿßÿ°",
    checkout_title: "ÿßŸÑÿØŸÅÿπ",
    full_name: "ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ",
    phone_1: "ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ (Ÿ°Ÿ° ÿ±ŸÇŸÖ)",
    phone_2: "ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿ¢ÿÆÿ± (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)",
    address: "ÿπŸÜŸàÿßŸÜ ÿßŸÑÿ¥ÿ≠ŸÜ ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ",
    custom_title: "ÿÆÿµÿµ ÿ±ÿ≥ÿßŸÑÿ™ŸÉ ÿßŸÑÿ≥ÿ±Ÿäÿ©",
    custom_hint: "ÿßŸÉÿ™ÿ® ÿßŸÑÿßÿ≥ŸÖ ŸÑÿ±ÿ§Ÿäÿ© ÿ¥ŸÉŸÑ ÿ¥ŸÅÿ±ÿ© ŸÖŸàÿ±ÿ≥:",
    custom_limit: "(ÿ≠ÿØ ÿ£ŸÇÿµŸâ Ÿ°Ÿ† ÿ≠ÿ±ŸàŸÅ)",
    place_order: "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ∑ŸÑÿ®",
    contact_us: "ÿßÿ™ÿµŸÑ ÿ®ŸÜÿß",
    send_msg: "ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©",
    footer_rights: "ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©.",
    back_shop: "ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÖÿ™ÿ¨ÿ±",
    you_like: "ŸÇÿØ Ÿäÿπÿ¨ÿ®ŸÉ ÿ£Ÿäÿ∂ÿßŸã",
    added_cart: "ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑÿ≥ŸÑÿ© ÿ®ŸÜÿ¨ÿßÿ≠",
    order_success_title: "ÿ™ŸÖ ÿßŸÑÿ∑ŸÑÿ® ÿ®ŸÜÿ¨ÿßÿ≠! üéâ",
    order_success_msg: "ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ∑ŸÑÿ®ŸÉ. ŸÑŸÇÿØ ÿßÿ≥ÿ™ŸÑŸÖŸÜÿß ÿßŸÑÿ∑ŸÑÿ® Ÿàÿ≥ŸÜÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÇÿ±Ÿäÿ®ÿßŸã ŸÑÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ.",
    close: "ÿ•ÿ∫ŸÑÿßŸÇ",
    fill_fields: "Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©",
    phone_error: "Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ™ŸÉŸàŸÜ ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ ŸÖŸÜ Ÿ°Ÿ° ÿ±ŸÇŸÖÿßŸã",
    secure_checkout: "ÿØŸÅÿπ ÿ¢ŸÖŸÜ",
    easy_returns: "ÿ≥ŸáŸàŸÑÿ© ÿßŸÑÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ",
    customer_support: "ÿØÿπŸÖ ŸÅŸÜŸä"
  }
};

let currentUserId = null;
const state = {
  lang: 'en', 
  page: 'home',
  cart: [],
  selectedProductId: null, 
  searchQuery: '', 
  showSuccessModal: false, 
  products: [
    { id: 1, name: 'Gold Morse Code Necklace', price: 750, originalPrice: 1100, description: 'Elegant gold bar necklace encoding a message in dots and dashes.', image: './goldennecklace.avif' },
    { id: 2, name: 'Gold Morse Code Bracelet', price: 550, originalPrice: 900, description: 'Delicate 14k gold bracelet with a Morse code message.', image: './goldenbracelet.avif' },
    { id: 3, name: 'Silver Morse Code Necklace', price: 750, originalPrice: 1100, description: 'Polished silver necklace with a hidden message pattern.', image: './silvernecklace.png' },
    { id: 4, name: 'Silver Cord Bracelet Set', price: 550, originalPrice: 900, description: 'Cord bracelet set with silver beads for customization.', image: './silverbracelet.webp' },
  ],
  message: '',
  messageType: 'success', 
  isAuthReady: false,
};

// Shipping Constants
const SHIPPING_COST = 100;
const FREE_SHIPPING_THRESHOLD = 1000;

function t(key) { return translations[state.lang][key] || key; }

function nav(pageName) {
    state.page = pageName;
    render();
    window.scrollTo(0,0);
}

function toggleLang() {
  state.lang = state.lang === 'en' ? 'ar' : 'en';
  document.body.dir = state.lang === 'ar' ? 'rtl' : 'ltr';
  if(state.lang === 'ar') document.body.classList.add('font-arabic');
  else document.body.classList.remove('font-arabic');
  render();
}

function updateTitle() {
  if (state.page === 'product_detail' && state.selectedProductId) {
    const p = findProduct(state.selectedProductId);
    document.title = state.lang === 'en' ? `Buy ${p.name} | Morse Jewelry` : `ÿ¥ÿ±ÿßÿ° ${p.name} | ŸÖŸàÿ±ÿ≥ ŸÑŸÑŸÖÿ¨ŸàŸáÿ±ÿßÿ™`;
  } else {
    document.title = state.lang === 'en' ? "Morse Jewelry | Express Yourself in Secret" : "ŸÖŸàÿ±ÿ≥ ŸÑŸÑŸÖÿ¨ŸàŸáÿ±ÿßÿ™ | ÿπÿ®ÿ± ÿπŸÜ ŸÜŸÅÿ≥ŸÉ ÿ®ÿ≥ÿ±Ÿäÿ©";
  }
}

// ---------- Authentication ----------
async function ensureAnonymousSignIn() {
  onAuthStateChanged(auth, user => {
    if (user) { currentUserId = user.uid; state.isAuthReady = true; render(); } 
    else { signInAnonymously(auth).then(cred => { currentUserId = cred.user.uid; state.isAuthReady = true; render(); }); }
  });
}
ensureAnonymousSignIn();

// ---------- Utility ----------
function findProduct(id) { return state.products.find(p=>p.id===Number(id)); }

function addToCart(productId) {
  const existing = state.cart.find(i => i.productId === productId);
  if(existing) existing.quantity++;
  else state.cart.push({productId, quantity:1});
  flashMessage(t('added_cart'), 'success');
  render();
}

function updateQuantity(productId, qty){
  if(qty<=0) state.cart = state.cart.filter(i=>i.productId!==productId);
  else { const item = state.cart.find(i=>i.productId===productId); if(item) item.quantity=qty; }
  render();
}

function clearCart() { state.cart=[]; render(); }

function cartItems() {
  return state.cart.map(ci=>{
    const p=findProduct(ci.productId);
    if(!p) return null;
    return {...p, quantity: ci.quantity, subtotal: +(p.price*ci.quantity).toFixed(2)};
  }).filter(Boolean);
}

// Shipping Logic
function cartTotal() { 
  const sub = cartItems().reduce((s,it)=>s+it.subtotal,0);
  if (sub === 0) return 0;
  if (sub >= FREE_SHIPPING_THRESHOLD) return sub; 
  return sub + SHIPPING_COST; 
}

function translateToMorse(text) {
  return text.toLowerCase().split('').map(char => MORSE_CODE[char] || char).join(' ');
}

// ---------- Notifications ----------
let flashTimer = null;
function flashMessage(msg, type='success', ms=3000){
  state.message = msg;
  state.messageType = type;
  render();
  if(flashTimer) clearTimeout(flashTimer);
  flashTimer=setTimeout(()=>{state.message=''; render();}, ms);
}

function showSuccessModal() { state.showSuccessModal = true; render(); }
function closeSuccessModal() { state.showSuccessModal = false; render(); }

function viewProduct(id) {
  state.selectedProductId = Number(id);
  state.page = 'product_detail';
  render();
  window.scrollTo(0,0);
}

function handleSearch(evt) {
  state.searchQuery = evt.target.value.toLowerCase();
  if(state.page !== 'home') {
      state.page = 'home';
  }
  render(); 
}

// ---------- Firestore & Sheets ----------
async function submitOrderToFirestore(orderData){
  if(!currentUserId){ flashMessage('Auth not ready', 'error'); return false; }
  try{ 
    await addDoc(collection(db,'orders'), {...orderData,userId:currentUserId,timestamp:serverTimestamp()}); 
    if(GOOGLE_SCRIPT_URL) {
       fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "application/json" }, body: JSON.stringify(orderData) }).catch(e => console.error(e));
    }
    return true; 
  }
  catch(e){ console.error(e); flashMessage('Order failed: ' + e.message, 'error'); return false; }
}

async function submitContactToFirestore(contactData){
  if(!currentUserId){ flashMessage('Auth not ready', 'error'); return false; }
  try{ await addDoc(collection(db,'contact_messages'), {...contactData,userId:currentUserId,timestamp:serverTimestamp()}); flashMessage(t('send_msg') + ' success', 'success'); return true; }
  catch(e){ console.error(e); flashMessage('Failed', 'error'); return false; }
}

// ---------- DOM ----------
const root = document.getElementById('root');
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

// ---------- Render Functions ----------
function renderNavbar(){
  const cartCount = state.cart.reduce((s,i)=>s+i.quantity,0);
  const langLabel = state.lang === 'en' ? 'üåê AR' : 'üåê EN';
  
  return `
  <div class="bg-gray-900 text-white text-sm font-bold text-center py-3 tracking-wide">
    ${t('shipping_banner')}
  </div>

  <nav class="bg-white shadow sticky top-0 z-20">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
      
      <div class="flex items-center gap-3 w-full md:w-auto justify-between md:justify-start">
        <div class="flex items-center gap-2 cursor-pointer" onclick="window._app.nav('home')">
            <img src="./morse_code.png" alt="Logo" class="h-10 md:h-16 w-auto object-contain">
            <span class="text-lg md:text-xl font-bold text-gray-800 tracking-wide">${t('title')}</span>
        </div>
        
        <div class="flex items-center gap-2 md:hidden">
            <button onclick="window._app.toggleLang()" class="px-2 py-1 border rounded text-xs font-bold text-pink-600">${langLabel}</button>
            <button onclick="window._app.nav('cart')" class="relative p-2 text-gray-700">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17" /></svg>
             ${cartCount ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-1.5 py-0.5 text-[10px] font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-pink-600 rounded-full">${cartCount}</span>` : ''}
            </button>
        </div>
      </div>

      <div class="flex items-center gap-4 w-full md:w-auto">
        
        <div class="relative flex-1 md:flex-none">
            <input type="text" placeholder="${t('search_placeholder')}" 
                value="${state.searchQuery}"
                oninput="window._app.handleSearch(event)"
                class="w-full md:w-48 pl-3 pr-8 py-1.5 rounded-full border border-gray-300 focus:outline-none focus:border-pink-500 text-sm transition-all focus:w-full md:focus:w-64"
            >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
        </div>

        <div class="hidden md:flex items-center gap-4">
            <button onclick="window._app.nav('home')" class="text-sm font-medium text-gray-700 hover:text-pink-600 uppercase cursor-pointer">${t('shop')}</button>
            <button onclick="window._app.nav('gallery')" class="text-sm font-medium text-gray-700 hover:text-pink-600 cursor-pointer">${t('gallery')}</button>
            <button onclick="window._app.toggleLang()" class="px-2 py-1 border rounded text-xs hover:bg-gray-100 font-bold text-pink-600">${langLabel}</button>
            <button onclick="window._app.nav('cart')" class="relative p-2 text-gray-700 hover:text-pink-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17" />
              </svg>
              ${cartCount ? `<span class="absolute top-0 right-0 inline-flex items-center justify-center px-1.5 py-0.5 text-xs font-bold leading-none text-red-100 transform translate-x-1/2 -translate-y-1/2 bg-pink-600 rounded-full">${cartCount}</span>` : ''}
            </button>
        </div>
      </div>

    </div>
  </nav>`;
}

function renderHome(){
  const filteredProducts = state.products.filter(p => p.name.toLowerCase().includes(state.searchQuery));

  return `
  <section class="py-6 px-4 max-w-7xl mx-auto">
    
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 md:p-12 mb-12 flex flex-col md:flex-row items-center gap-8">
        <div class="flex-1 w-full"><img src="./morse_logo_transparent.png" alt="Morse Code" class="w-full rounded-xl shadow-md object-cover"></div>
        <div class="flex-1 space-y-4">
            <h2 class="text-2xl font-bold text-gray-800">${t('morse_title')}</h2>
            <p class="text-gray-600 leading-relaxed">${t('morse_desc_1')}</p>
            <p class="text-gray-600 leading-relaxed">${t('morse_desc_2')}</p>
            <p class="text-pink-600 font-medium italic">${t('morse_secret')}</p>
        </div>
    </div>

    <div class="text-center mb-8">
        <h1 class="text-2xl md:text-4xl font-extrabold text-gray-900 mb-2">${t('hero_title')}</h1>
        <p class="text-sm md:text-lg text-gray-600">${t('hero_sub')}</p>
    </div>

    <h2 class="text-xl font-bold mb-4 text-gray-900 border-b pb-2">${t('collection')}</h2>
    
    ${filteredProducts.length === 0 ? `<div class="text-center text-gray-500 py-12">No products found matching "${state.searchQuery}"</div>` : ''}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-16">
      ${filteredProducts.map(p=>`
      <article class="bg-white rounded-xl shadow-sm overflow-hidden flex flex-col cursor-pointer transition-all duration-300 hover:shadow-2xl hover:-translate-y-1 group" onclick="window._app.viewProduct(${p.id})">
        <div class="overflow-hidden">
             <img src="${escapeHtml(p.image)}" alt="${escapeHtml(p.name)}" class="w-full h-64 md:h-48 object-cover transition duration-700 group-hover:scale-110" />
        </div>
        <div class="p-4 flex flex-col flex-1">
          <h3 class="text-lg font-semibold group-hover:text-pink-600 transition">${escapeHtml(p.name)}</h3>
          <div class="mt-auto pt-4 flex items-center justify-between">
            <div>
              <span class="text-gray-400 line-through text-sm block">${p.originalPrice} ${t('original_price')}</span>
              <strong class="text-pink-600 text-xl">${p.price.toFixed(2)} ${t('original_price')}</strong>
            </div>
            <button onclick="event.stopPropagation(); window._app.viewProduct(${p.id})" class="px-4 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 shadow-md hover:shadow-lg transition">${t('customize')}</button>
          </div>
        </div>
      </article>`).join('')}
    </div>
  </section>`;
}

function renderProductDetail() {
  const mainProduct = findProduct(state.selectedProductId) || state.products[0];
  const otherProducts = state.products.filter(p => p.id !== mainProduct.id);

  return `
  <section class="py-8 px-4 max-w-7xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
        <div class="mb-6">
          <button onclick="window._app.nav('home')" class="text-gray-500 hover:text-pink-600 mb-4 inline-flex items-center gap-1">
             ${state.lang==='ar' ? '&rarr;' : '&larr;'} ${t('back_shop')}
          </button>
          <img src="${escapeHtml(mainProduct.image)}" alt="${escapeHtml(mainProduct.name)}" class="w-full h-96 object-cover rounded-lg shadow-sm">
        </div>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">${escapeHtml(mainProduct.name)}</h1>
        <p class="text-gray-600 mb-6 text-lg leading-relaxed">${escapeHtml(mainProduct.description)}</p>

        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200 mb-6">
            <label class="block text-sm font-bold text-gray-700 mb-2">${t('custom_title')} <span class="text-xs font-normal text-gray-500">${t('custom_limit')}</span></label>
            <input type="text" maxlength="10" placeholder="Type name here (e.g., ANNA)..." 
                class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-pink-500 focus:outline-none mb-3 text-lg"
                oninput="document.getElementById('morse-preview').textContent = window._app.translateToMorse(this.value)"
            >
            <div class="text-center">
                <span class="text-sm text-gray-500">${t('custom_hint')}</span>
                <div id="morse-preview" class="text-3xl font-extrabold text-pink-600 mt-2 tracking-widest min-h-[40px]">...</div>
            </div>
        </div>
        
        <div class="flex flex-col sm:flex-row items-center justify-between border-t pt-6 gap-4">
          <div>
            <span class="text-xl text-gray-400 line-through mr-2">${mainProduct.originalPrice} ${t('original_price')}</span>
            <span class="text-4xl font-extrabold text-pink-600">${mainProduct.price.toFixed(2)} ${t('original_price')}</span>
          </div>
          <button onclick="window._app.addToCart(${mainProduct.id})" class="w-full sm:w-auto px-8 py-4 bg-pink-600 text-white text-lg font-bold rounded-lg shadow-lg hover:shadow-xl hover:bg-pink-700 transform transition hover:scale-105">${t('add_cart')}</button>
        </div>
      </div>

      <div class="lg:col-span-1">
        <h3 class="text-xl font-bold mb-4 text-gray-800">${t('you_like')}</h3>
        <div class="space-y-4">
          ${otherProducts.map(p => `
            <div class="bg-white rounded-lg shadow p-3 flex items-center gap-4 cursor-pointer hover:bg-gray-50 transition border border-transparent hover:border-pink-200" onclick="window._app.viewProduct(${p.id})">
              <img src="${escapeHtml(p.image)}" class="w-20 h-20 object-cover rounded" alt="${escapeHtml(p.name)}">
              <div>
                <h4 class="font-semibold text-gray-800 text-sm">${escapeHtml(p.name)}</h4>
                <div class="mt-1"><span class="text-sm font-bold text-pink-600">${p.price} ${t('original_price')}</span></div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  </section>`;
}

function renderGallery(){
  return `
  <section class="py-12 px-4 max-w-7xl mx-auto">
    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 text-center mb-4">${t('spotlight')}</h1>
    <p class="text-center text-gray-500 mb-8">${t('spotlight_sub')}</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
      ${state.products.map(p=>`
      <div class="bg-white rounded-xl shadow overflow-hidden group cursor-pointer relative" onclick="window._app.viewProduct(${p.id})">
        <div class="aspect-[1/1] overflow-hidden">
          <img src="${escapeHtml(p.image)}" alt="${escapeHtml(p.name)}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" />
        </div>
        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition flex items-center justify-center">
          <span class="opacity-0 group-hover:opacity-100 bg-white text-pink-600 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-4 group-hover:translate-y-0 transition">${t('shop_now')}</span>
        </div>
      </div>`).join('')}
    </div>
  </section>`;
}

function renderCart(){
  const items = cartItems();
  const subtotal = cartItems().reduce((s,it)=>s+it.subtotal,0);
  const total = cartTotal();
  // Check for Free Shipping
  const shippingDisplay = subtotal >= FREE_SHIPPING_THRESHOLD ? `<span class="text-green-600 font-bold">${t('free')}</span>` : `${SHIPPING_COST.toFixed(2)} ${t('original_price')}`;

  if(items.length===0) return `<section class="py-12 px-4 max-w-3xl mx-auto text-center"><h2 class="text-2xl font-bold mb-4">${t('cart_empty')}</h2><button class="px-6 py-2 bg-pink-600 text-white rounded" onclick="window._app.nav('home')">${t('shop_now')}</button></section>`;
  
  return `
  <section class="py-12 px-4 max-w-4xl mx-auto">
    <h2 class="text-3xl font-bold mb-6">${t('your_cart')}</h2>
    <div class="space-y-4">
      ${items.map(it=>`
      <div class="flex items-center bg-white p-4 rounded-lg shadow">
        <img src="${escapeHtml(it.image)}" alt="${escapeHtml(it.name)}" class="w-20 h-20 object-cover rounded mr-4" />
        <div class="flex-1">
          <h3 class="font-semibold">${escapeHtml(it.name)}</h3>
          <p class="text-gray-600">${it.price.toFixed(2)} ${t('original_price')}</p>
        </div>
        <div class="flex items-center space-x-4">
          <input data-cart-qty="${it.id}" type="number" min="1" value="${it.quantity}" class="w-16 p-2 border rounded" />
          <span class="text-lg font-bold">${it.subtotal.toFixed(2)}</span>
        </div>
      </div>`).join('')}
    </div>
    
    <div class="mt-8 pt-6 border-t border-gray-200">
      <div class="flex justify-between items-center mb-2"><span class="text-gray-600">${t('subtotal')}</span><span class="font-bold">${subtotal.toFixed(2)} ${t('original_price')}</span></div>
      <div class="flex justify-between items-center mb-2"><span class="text-gray-600">${t('shipping')}</span><span class="font-bold">${shippingDisplay}</span></div>
      <div class="flex justify-between items-center text-xl mt-4 border-t pt-4"><h3 class="font-bold">${t('total')}</h3><div class="font-extrabold text-pink-600">${total.toFixed(2)} ${t('original_price')}</div></div>
    </div>

    <div class="mt-6 flex justify-end gap-4">
      <button id="btn-clear-cart" class="px-6 py-3 border rounded">${t('clear_cart')}</button>
      <button class="px-6 py-3 bg-pink-600 text-white rounded" onclick="window._app.nav('checkout')">${t('proceed')}</button>
    </div>
  </section>`;
}

function renderCheckout(){
  const items = cartItems();
  const subtotal = cartItems().reduce((s,it)=>s+it.subtotal,0);
  const total = cartTotal();
  const shippingFeeFinal = subtotal >= FREE_SHIPPING_THRESHOLD ? 0 : SHIPPING_COST;

  if(items.length===0) return `<section class="py-12 px-4 max-w-2xl mx-auto text-center"><p class="text-lg">${t('cart_empty')}</p><div class="mt-4"><button class="px-4 py-2 bg-pink-600 text-white rounded" onclick="window._app.nav('home')">${t('shop_now')}</button></div></section>`;
  
  return `
  <section class="py-12 px-4 max-w-2xl mx-auto">
    <h2 class="text-3xl font-bold mb-6">${t('checkout_title')}</h2>
    <form id="checkout-form" class="bg-white p-6 rounded shadow space-y-4" onsubmit="window._app.handleCheckoutSubmit(event)">
      <div><label class="block text-sm font-medium text-gray-700">${t('full_name')}</label><input name="name" required class="mt-1 block w-full p-2 border rounded" /></div>
      <div><label class="block text-sm font-medium text-gray-700">${t('phone_1')}</label><input name="phone1" type="tel" maxlength="11" required class="mt-1 block w-full p-2 border rounded" placeholder="01xxxxxxxxx" /></div>
      <div><label class="block text-sm font-medium text-gray-700">${t('phone_2')}</label><input name="phone2" type="tel" class="mt-1 block w-full p-2 border rounded" /></div>
      <div><label class="block text-sm font-medium text-gray-700">${t('address')}</label><textarea name="address" required class="mt-1 block w-full p-2 border rounded"></textarea></div>
      
      <div>
        <label class="block text-sm font-bold text-gray-800 bg-pink-50 p-2 rounded-t">${t('custom_title')}</label>
        <div class="bg-gray-50 p-3 rounded-b border border-gray-200">
            <p class="text-xs text-gray-500 mb-2">${t('custom_hint')} ${t('custom_limit')}</p>
            <textarea name="custom_text" required class="block w-full p-2 border rounded focus:ring-1 focus:ring-pink-500" placeholder="e.g. ANNA"></textarea>
        </div>
      </div>

      <div><h3 class="font-semibold border-t pt-4 mt-4">${t('total')}</h3><div class="mt-2 text-right font-bold text-xl">${total.toFixed(2)} ${t('original_price')}</div></div>
      
      <div class="flex justify-end"><button type="submit" class="px-6 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 w-full md:w-auto">${t('place_order')}</button></div>
      
      <div class="flex justify-center gap-4 mt-6 text-xs text-gray-500 border-t pt-4">
        <div class="flex items-center gap-1"><span class="text-lg">üîí</span> ${t('secure_checkout')}</div>
        <div class="flex items-center gap-1"><span class="text-lg">‚úÖ</span> ${t('easy_returns')}</div>
        <div class="flex items-center gap-1"><span class="text-lg">üìû</span> ${t('customer_support')}</div>
      </div>
    </form>
  </section>`;
}

function renderContact(){
  return `
  <section class="py-12 px-4 max-w-xl mx-auto">
    <h2 class="text-3xl font-bold mb-4 text-center">${t('contact_us')}</h2>
    <form id="contact-form" class="bg-white p-6 rounded shadow space-y-4" onsubmit="window._app.handleContactSubmit(event)">
      <input name="name" placeholder="${t('full_name')}" required class="w-full p-2 border rounded" />
      <input name="phone" type="tel" placeholder="${t('phone_1')}" required class="w-full p-2 border rounded" />
      <textarea name="message" placeholder="Message..." required class="w-full p-2 border rounded"></textarea>
      <div class="text-center"><button type="submit" class="px-6 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">${t('send_msg')}</button></div>
    </form>
  </section>`;
}

function renderFooter(){
  return `
  <footer class="bg-gray-800 text-white py-8 mt-8">
    <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-6">
      <div class="text-center md:text-left"><h4 class="text-xl font-bold">${t('title')}</h4><div class="text-sm text-gray-400 mt-1">&copy; 2025 ${t('footer_rights')}</div></div>
      <div class="flex flex-col items-center md:items-end gap-3">
        <p class="font-semibold mb-1">Socials:</p>
        <a href="https://wa.me/201281770085" target="_blank" class="flex items-center gap-2 hover:text-green-400"><span>WhatsApp: +201281770085</span></a>
        <a href="https://www.instagram.com/2annyyy" target="_blank" class="flex items-center gap-2 hover:text-pink-400"><span>Instagram: @2annyyy</span></a>
      </div>
    </div>
  </footer>`;
}

function renderSuccessModal() {
  if (!state.showSuccessModal) return '';
  return `
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full text-center modal-fade-in border-4 border-green-100">
      <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
      </div>
      <h3 class="text-2xl font-bold text-gray-900 mb-2">${t('order_success_title')}</h3>
      <p class="text-gray-600 mb-8">${t('order_success_msg')}</p>
      <button onclick="window._app.closeSuccessModal()" class="w-full py-3 bg-gray-900 text-white rounded-xl font-bold hover:bg-gray-800 transition transform hover:scale-105">${t('close')}</button>
    </div>
  </div>`;
}

function render(){
  updateTitle();
  const readyClass = state.isAuthReady?'visible-ready':'hidden-until-ready';
  root.className=readyClass;

  let content = '';
  if (state.page === 'home') content = renderHome();
  else if (state.page === 'gallery') content = renderGallery();
  else if (state.page === 'contact') content = renderContact();
  else if (state.page === 'cart') content = renderCart();
  else if (state.page === 'checkout') content = renderCheckout();
  else if (state.page === 'product_detail') content = renderProductDetail();

  const flashColorClass = state.messageType === 'success' ? 'bg-green-600' : 'bg-red-600';

  root.innerHTML=`
    <div class="min-h-screen flex flex-col">
      ${renderNavbar()}
      <main class="flex-1 bg-gray-50">${content}</main>
      ${renderFooter()}
      ${state.message ? `<div id="flash" class="flash-slide-in fixed top-6 left-1/2 transform -translate-x-1/2 ${flashColorClass} text-white px-8 py-3 rounded-full shadow-lg z-50 text-center font-medium">${escapeHtml(state.message)}</div>` : ''}
      ${renderSuccessModal()}
    </div>
  `;
  
  document.querySelectorAll('[data-cart-qty]').forEach(input=>input.onchange=()=>{ const id=Number(input.getAttribute('data-cart-qty')); const value=parseInt(input.value)||0; updateQuantity(id,value); });
  const clearBtn = document.getElementById('btn-clear-cart'); if(clearBtn) clearBtn.onclick=clearCart;
}

async function handleCheckoutSubmit(evt){
  evt.preventDefault();
  const form = evt.target;
  const name = form.name.value.trim();
  const phone1 = form.phone1.value.trim();
  const phone2 = form.phone2.value.trim();
  const address = form.address.value.trim();
  const customText = form.custom_text.value.trim();

  const phoneRegex = /^\d{11}$/;
  if (!phoneRegex.test(phone1)) { flashMessage(t('phone_error'), 'error'); return; }
  if(!name || !phone1 || !address || !customText){ flashMessage(t('fill_fields'), 'error'); return; }

  // Recalculate shipping inside here for the database
  const subtotal = cartItems().reduce((s,it)=>s+it.subtotal,0);
  const finalShippingFee = subtotal >= FREE_SHIPPING_THRESHOLD ? 0 : SHIPPING_COST;

  const orderData = { name, phone1, phone2, address, customText, items: cartItems(), totalPrice: cartTotal(), shippingFee: finalShippingFee, currency: 'EGP' };
  
  const success = await submitOrderToFirestore(orderData);
  if(success){ 
    clearCart(); 
    state.page='home'; 
    showSuccessModal(); 
  }
}

async function handleContactSubmit(evt){
  evt.preventDefault();
  const form = evt.target;
  const name = form.name.value.trim();
  const phone = form.phone.value.trim();
  const message = form.message.value.trim();
  if(!name || !phone || !message){ flashMessage(t('fill_fields'), 'error'); return; }
  const contactData = { name, phone, message };
  const success = await submitContactToFirestore(contactData);
  if(success){ form.reset(); }
}

window._app={state, addToCart, viewProduct, updateQuantity, clearCart, cartItems, cartTotal, toggleLang, translateToMorse, handleSearch, render, closeSuccessModal, nav, handleCheckoutSubmit, handleContactSubmit};

render();
</script>
</body>
</html>
